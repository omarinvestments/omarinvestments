rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // Helper Functions
    // =========================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    // =========================================================================
    // RBAC Helper Functions (New System)
    // =========================================================================

    // Check if user is a super-admin
    function isSuperAdmin() {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isSuperAdmin == true;
    }

    // Get user's LLC member document
    function memberDoc(llcId) {
      return get(/databases/$(database)/documents/llcs/$(llcId)/members/$(request.auth.uid));
    }

    // Check if user is an LLC admin (via members collection)
    function isLlcAdmin(llcId) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/llcs/$(llcId)/members/$(request.auth.uid)) &&
        memberDoc(llcId).data.status == "active" &&
        memberDoc(llcId).data.role == "admin";
    }

    // Check if user is an active member of an LLC (legacy support)
    function isMember(llcId) {
      return isSignedIn() &&
        exists(/databases/$(database)/documents/llcs/$(llcId)/members/$(request.auth.uid)) &&
        memberDoc(llcId).data.status == "active";
    }

    // Get user's role in an LLC
    function role(llcId) {
      return memberDoc(llcId).data.role;
    }

    // Check if user has one of the specified roles
    function hasRole(llcId, roles) {
      return isMember(llcId) && roles.hasAny([role(llcId)]);
    }

    // Check if user has LLC access via assignments
    function hasLlcAssignment(llcId) {
      // Note: This is a simplified check. Full assignment validation done server-side.
      return isSuperAdmin() || isLlcAdmin(llcId);
    }

    // Property scoping: if user has property scopes, limit access
    function canAccessProperty(llcId, propertyId) {
      let scopes = memberDoc(llcId).data.propertyScopes;
      return scopes == null || scopes.size() == 0 || scopes.hasAny([propertyId]);
    }

    // Case scoping: restricted cases require explicit access
    function canAccessCase(llcId, caseId) {
      let r = role(llcId);
      let scopes = memberDoc(llcId).data.caseScopes;
      return r == "admin" || r == "legal" || (scopes != null && scopes.hasAny([caseId]));
    }

    // =========================================================================
    // Users (Unified user collection)
    // =========================================================================

    match /users/{userId} {
      // Users can read their own record
      allow read: if isSignedIn() && request.auth.uid == userId;
      // Super-admins can read all
      allow read: if isSuperAdmin();
      // Only server (Admin SDK) can write
      allow write: if false;
    }

    // =========================================================================
    // User Assignments (RBAC - New)
    // =========================================================================

    match /userAssignments/{assignmentId} {
      // Users can read their own assignments
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      // Super-admins can read all
      allow read: if isSuperAdmin();
      // Only server (Admin SDK) can write
      allow write: if false;
    }

    // =========================================================================
    // Global Tasks (RBAC - New)
    // =========================================================================

    match /globalTasks/{taskId} {
      // Users can read tasks assigned to them
      allow read: if isSignedIn() && resource.data.assignedToUserId == request.auth.uid;
      // Users can read tasks they created
      allow read: if isSignedIn() && resource.data.createdByUserId == request.auth.uid;
      // Super-admins can read all
      allow read: if isSuperAdmin();
      // LLC admins can read tasks in their LLCs
      allow read: if isSignedIn() &&
        resource.data.llcId != null &&
        isLlcAdmin(resource.data.llcId);
      // Only server (Admin SDK) can write
      allow write: if false;
    }

    // =========================================================================
    // Platform Accounts (top-level)
    // =========================================================================

    match /platformAccounts/{platformAccountId} {
      allow read: if isSignedIn() && resource.data.ownerUserId == request.auth.uid;
      allow write: if false; // Functions only
    }

    // =========================================================================
    // Global Tenants
    // =========================================================================

    match /tenants/{tenantId} {
      // Authenticated users can read tenants (API handles authorization)
      allow read: if isSignedIn();

      // Tenant users can read their own record via userId field
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      // All writes go through API (which verifies permissions)
      allow write: if false; // API only via Admin SDK
    }

    // =========================================================================
    // LLCs
    // =========================================================================

    match /llcs/{llcId} {
      // Super-admin can read all LLCs
      allow read: if isSuperAdmin();
      // Members can read their LLC
      allow read: if isMember(llcId);
      // Only admins (or super-admins via server) can write
      allow write: if hasRole(llcId, ["admin"]);
    }

    match /llcs/{llcId}/members/{userId} {
      // Super-admin can read all members
      allow read: if isSuperAdmin();
      // Members can read their LLC's members
      allow read: if isMember(llcId);
      // Only admins can write
      allow write: if hasRole(llcId, ["admin"]);
    }

    // =========================================================================
    // Properties & Units
    // =========================================================================

    match /llcs/{llcId}/properties/{propertyId} {
      allow read: if isSuperAdmin() || (isMember(llcId) && canAccessProperty(llcId, propertyId));
      allow create, update, delete: if isSuperAdmin() || hasRole(llcId, ["admin", "manager"]);
    }

    match /llcs/{llcId}/properties/{propertyId}/units/{unitId} {
      allow read: if isSuperAdmin() || (isMember(llcId) && canAccessProperty(llcId, propertyId));
      allow create, update, delete: if isSuperAdmin() || hasRole(llcId, ["admin", "manager"]);
    }

    // =========================================================================
    // Tenants (LLC-scoped)
    // =========================================================================

    match /llcs/{llcId}/tenants/{tenantId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "legal", "accounting"])
                  || (role(llcId) == "tenant" && resource.data.userId == request.auth.uid);
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "legal"]);
    }

    // =========================================================================
    // Leases
    // =========================================================================

    match /llcs/{llcId}/leases/{leaseId} {
      allow read: if isSuperAdmin() || (isMember(llcId) && (
        hasRole(llcId, ["admin", "manager", "legal", "accounting"]) ||
        (role(llcId) == "tenant" && request.auth.uid in resource.data.tenantUserIds)
      ));
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "legal"]);
    }

    match /llcs/{llcId}/leases/{leaseId}/documents/{docId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "legal", "accounting"]);
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "manager"]);
    }

    // =========================================================================
    // Charges & Payments
    // =========================================================================

    match /llcs/{llcId}/charges/{chargeId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "accounting", "legal"])
                  || (role(llcId) == "tenant" && request.auth.uid == resource.data.tenantUserId);
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "accounting"]);
    }

    match /llcs/{llcId}/payments/{paymentId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "accounting", "legal"])
                  || (role(llcId) == "tenant" && request.auth.uid == resource.data.tenantUserId);
      allow create: if role(llcId) == "tenant";
      allow update, delete: if false; // Functions only (webhook)
    }

    // =========================================================================
    // Ledger (Functions only)
    // =========================================================================

    match /llcs/{llcId}/ledgerEntries/{entryId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "accounting", "manager"]);
      allow write: if false; // Functions only
    }

    // =========================================================================
    // Bills & Vendors
    // =========================================================================

    match /llcs/{llcId}/vendors/{vendorId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "accounting"]);
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "accounting"]);
    }

    match /llcs/{llcId}/bills/{billId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "accounting"]);
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "accounting"]);
    }

    match /llcs/{llcId}/utilityAccounts/{utilityId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "accounting"]);
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "accounting"]);
    }

    // =========================================================================
    // Work Orders (Updated for RBAC)
    // =========================================================================

    match /llcs/{llcId}/workOrders/{workOrderId} {
      // Super-admin has full access
      allow read: if isSuperAdmin();
      // LLC admins and managers can read
      allow read: if hasRole(llcId, ["admin", "manager", "maintenance"]);
      // Tenant who requested can read their own
      allow read: if role(llcId) == "tenant" && resource.data.requestedByTenantId == request.auth.uid;
      // Assigned employees can read (checked server-side via assignedEmployeeIds)
      allow read: if isSignedIn() && request.auth.uid in resource.data.assignedEmployeeIds;

      // Create permissions
      allow create: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "maintenance", "tenant"]);

      // Update permissions
      allow update: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "maintenance"]);
      allow update: if isSignedIn() && request.auth.uid in resource.data.assignedEmployeeIds;

      // Delete (cancel) permissions
      allow delete: if isSuperAdmin() || hasRole(llcId, ["admin", "manager"]);
    }

    // =========================================================================
    // Legal Cases
    // =========================================================================

    match /llcs/{llcId}/cases/{caseId} {
      allow read: if isSuperAdmin() || (isMember(llcId) && canAccessCase(llcId, caseId));
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "legal"]);
    }

    match /llcs/{llcId}/cases/{caseId}/tasks/{taskId} {
      allow read: if isSuperAdmin() || (isMember(llcId) && canAccessCase(llcId, caseId));
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "legal"]);
    }

    match /llcs/{llcId}/cases/{caseId}/documents/{docId} {
      allow read: if isSuperAdmin() || (isMember(llcId) && canAccessCase(llcId, caseId));
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "legal"]);
    }

    match /llcs/{llcId}/cases/{caseId}/courtDates/{courtDateId} {
      allow read: if isSuperAdmin() || (isMember(llcId) && canAccessCase(llcId, caseId));
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin", "legal"]);
    }

    // =========================================================================
    // Lease Templates
    // =========================================================================

    match /llcs/{llcId}/leaseTemplates/{templateId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "manager", "legal"]);
      allow write: if isSuperAdmin() || hasRole(llcId, ["admin"]);
    }

    // =========================================================================
    // Audit Logs (Read-only, Functions write)
    // =========================================================================

    match /llcs/{llcId}/auditLogs/{logId} {
      allow read: if isSuperAdmin() || hasRole(llcId, ["admin", "legal", "accounting"]);
      allow write: if false; // Functions only
    }

    // =========================================================================
    // Stripe Events (Platform-level idempotency tracking)
    // =========================================================================

    match /stripeEvents/{eventId} {
      allow read, write: if false; // Functions only
    }

    // =========================================================================
    // Mortgages (Global collection - Super-admin only)
    // =========================================================================

    match /mortgages/{mortgageId} {
      allow read, write: if isSuperAdmin();

      match /payments/{paymentId} {
        allow read, write: if isSuperAdmin();
      }
    }
  }
}
